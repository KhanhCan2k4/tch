let le,T,ae,q,_,y,$,M,Z,C,w,S,Y,Q,F,X,B,D,z,R,ie,ce,W,ee,te,k,E,x,ne,fe,A,ye;const Me=()=>{console.log("[FM-UI] init: Bắt đầu tìm và gán các phần tử DOM."),le=document.getElementById("fileManagerContainer"),T=document.getElementById("fileManagerModal"),ae=document.getElementById("modalContent"),q=document.getElementById("closeModalBtn"),_=document.getElementById("cancelBtn"),y=document.getElementById("fileGrid"),$=document.getElementById("sidebarNav"),M=document.getElementById("searchInput"),Z=document.getElementById("uploadBtn"),C=document.getElementById("dropZone"),w=document.getElementById("dragOverlay"),S=document.getElementById("uploadFormModal"),Y=document.getElementById("uploadFormCloseBtn"),Q=document.getElementById("uploadFormCancelBtn"),F=document.getElementById("uploadFormSubmitBtn"),X=document.getElementById("pickFilesBtn"),B=document.getElementById("hiddenPickInput"),D=document.getElementById("pickedPreview"),z=document.getElementById("pickedCount"),R=document.getElementById("editFileModal"),ie=document.getElementById("editFileName"),ce=document.getElementById("editFileCategory"),W=document.getElementById("saveEditBtn"),ee=document.getElementById("cancelEditBtn"),te=document.getElementById("createFolderBtn"),k=document.getElementById("backBtn"),E=document.getElementById("sidebarDragOverlay"),x=document.getElementById("filePreviewModal"),ne=document.getElementById("previewCloseBtn"),fe=document.getElementById("previewTitle"),A=document.getElementById("previewContent"),ye=document.getElementById("previewDownloadLink"),console.log("[FM-UI] init: Gán DOM hoàn tất.")},Le=()=>{console.log("[FM-UI] openModal: Mở modal chính."),T&&(T.classList.remove("hidden"),T.classList.add("flex"),setTimeout(()=>ae.classList.remove("scale-95","opacity-0"),10))},ge=()=>{console.log("[FM-UI] closeModal: Đóng modal chính."),T&&(ae.classList.add("scale-95","opacity-0"),setTimeout(()=>{T.classList.add("hidden"),T.classList.remove("flex")},300))},he=()=>{console.log("[FM-UI] openUploadForm: Mở form upload."),S&&(S.classList.remove("hidden"),S.classList.add("flex"))},re=()=>{console.log("[FM-UI] closeUploadForm: Đóng form upload."),S&&(S.classList.add("hidden"),S.classList.remove("flex"))},me=()=>{console.log("[FM-UI] resetUploadForm: Reset lại form upload."),B&&(B.value=""),D&&(D.innerHTML=""),z&&(z.textContent="Chưa chọn tệp"),document.querySelectorAll('input[name="uploadCategory"]').forEach(t=>t.checked=t.value==="all")},be=t=>{console.log("[FM-UI] openEditModal: Mở form sửa file.",t),!(!R||!t)&&(ie.value=t.name,ce.value=t.category||"",R.classList.remove("hidden"),R.classList.add("flex"))},ue=()=>{console.log("[FM-UI] closeEditModal: Đóng form sửa file."),R&&(R.classList.add("hidden"),R.classList.remove("flex"))},ke=()=>{console.log("[FM-UI] openPreviewModal: Mở popup xem trước file."),x&&(x.classList.remove("hidden"),x.classList.add("flex"),setTimeout(()=>{var t;x.classList.add("opacity-100"),(t=x.querySelector(".transform"))==null||t.classList.remove("scale-95")},10))},$e=()=>{var t;console.log("[FM-UI] closePreviewModal: Đóng popup xem trước file."),x&&(x.classList.remove("opacity-100"),(t=x.querySelector(".transform"))==null||t.classList.add("scale-95"),setTimeout(()=>{x.classList.add("hidden"),x.classList.remove("flex"),A&&(A.innerHTML="")},300))},Fe=t=>{try{return new Intl.DateTimeFormat("vi-VN",{dateStyle:"short",timeStyle:"medium",hour12:!1,timeZone:"Asia/Ho_Chi_Minh"}).format(t)}catch{return t.toLocaleString("vi-VN",{hour12:!1})}},Te=t=>{if(t!=null&&t.uploaded_at){const n=new Date(t.uploaded_at);if(!isNaN(n.getTime()))return n}const r=/^picture(\d{2})-(\d{2})-(\d{2})-(\d{2})-(\d{2})/i.exec((t==null?void 0:t.name)||"");if(r){const[,n,e,o,s,h]=r,u=new Date().getFullYear();return new Date(Date.UTC(u,Number(e)-1,Number(n),Number(o),Number(s),Number(h)))}return null},H=async t=>{const r=await t.text(),n=t.headers.get("content-type")||"";if(console.log(`[SAFEJSON-DEBUG] Nhận phản hồi từ server. Status: ${t.status}, Content-Type: ${n}`),console.log(`[SAFEJSON-DEBUG] Nội dung phản hồi (raw text):
---BEGIN---
${r}
---END---`),!t.ok){if(console.error(`[SAFEJSON-ERROR] Server trả về lỗi HTTP ${t.status}.`),n.includes("application/json"))try{const e=JSON.parse(r);throw console.error("[SAFEJSON-ERROR] Chi tiết lỗi (JSON):",e),new Error(e.error_details||e.message||"Lỗi không xác định từ server.")}catch(e){throw console.error("[SAFEJSON-ERROR] Không thể phân tích JSON từ phản hồi lỗi. Lỗi gốc:",e),new Error(`Lỗi HTTP ${t.status}: Phản hồi không hợp lệ từ server. Chi tiết: ${r.substring(0,500)}`)}throw console.error("[SAFEJSON-ERROR] Phản hồi lỗi không phải là JSON. Đây có thể là trang lỗi HTML từ server."),new Error(`Lỗi HTTP ${t.status}. Chi tiết: ${r.substring(0,500)}`)}if(!n.includes("application/json"))throw console.error("[SAFEJSON-ERROR] Phản hồi thành công nhưng không phải là JSON. Nội dung:",r),new Error("Phản hồi không mong đợi: Server không trả về JSON.");return console.log("[SAFEJSON-SUCCESS] Phản hồi hợp lệ. Phân tích JSON..."),JSON.parse(r)},P="/api",Ne=(t="all",r="",n="/")=>{const e=encodeURIComponent(r),o=encodeURIComponent(n),s=`${P}/files?category=${t}&search=${e}&path=${o}`;return console.log(`[FM-API] ==> fetchFiles: GET ${s}`),fetch(s).then(H)},Ie=t=>{const r=`${P}/upload-files`;return console.log(`[FM-API] ==> uploadFiles: POST ${r}`),fetch(r,{method:"POST",body:t}).then(H)},we=t=>{const r=`${P}/delete-file`;return console.log(`[FM-API] ==> deleteFile: POST ${r}`,t),fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(H)},U=t=>{const r=`${P}/update-file`;return console.log(`[FM-API] ==> updateFile: POST ${r}`,t),fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(H)},pe=(t,r)=>{const n=`${P}/create-folder`;return console.log(`[FM-API] ==> createFolder: POST ${n}`,{name:t,path:r}),fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,path:r})}).then(H)},Ce=t=>{const r=`${P}/merge-files`;return console.log(`[FM-API] ==> mergeFiles: POST ${r}`),fetch(r,{method:"POST",body:t}).then(H)};let K=null;const Be=(t,r)=>{if(t.isIntersecting){r.unobserve(t.target);const n=t.target,e=n.dataset.src;if(e){console.log("[FM-RENDER] LazyLoad: Bắt đầu tải:",e);const o=new Image;o.src=e,o.className="w-full h-full object-contain transition-transform duration-200 group-hover:scale-105",o.onerror=()=>{console.error("[FM-RENDER] LazyLoad: Lỗi tải ảnh:",e),n.innerHTML='<div class="w-full h-full flex items-center justify-center bg-red-100 text-red-700 text-xs text-center p-1">Lỗi tải ảnh</div>',n.classList.remove("animate-pulse")},o.onload=()=>{console.log("[FM-RENDER] LazyLoad: Tải thành công:",e),n.innerHTML="",n.appendChild(o),n.classList.remove("animate-pulse","bg-gray-200","flex","items-center","justify-center")}}else n.classList.remove("animate-pulse","bg-gray-200")}},Ae=()=>{y&&(console.log("[FM-RENDER] renderGridLoader: Hiển thị loader."),y.innerHTML=`
            <div class="col-span-full flex flex-col items-center justify-center h-full py-10 mt-20">
                <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-gray-600">Đang tải dữ liệu...</p>
            </div>
        `)},Se=t=>{y&&(console.log(`[FM-RENDER] renderGridError: Hiển thị lỗi: "${t}"`),y.innerHTML=`<p class="col-span-full text-center text-red-600 font-sans p-4">${t}</p>`)},Re=t=>{if(!y){console.warn("[FM-RENDER] renderFileGrid: Bỏ qua vì ui.fileGrid không tồn tại.");return}if(y.innerHTML="",y.className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 items-start",!t||!t.length){console.log('[FM-RENDER] renderFileGrid: Không có file nào để hiển thị, hiển thị thông báo "Thư mục trống".'),y.innerHTML='<p class="col-span-full text-center text-gray-500 font-sans p-4">Thư mục trống.</p>';return}K&&K.disconnect(),console.log(`[FM-RENDER] ==> renderFileGrid: Bắt đầu render ${t.length} mục.`);const r=document.createDocumentFragment();t.forEach(e=>{const o=document.createElement("div");let s="";e.type==="folder"?(s="bg-blue-10 border-blue-300 hover:bg-blue-50 hover:ring-2 hover:ring-blue-500/50",e.is_empty&&(s+=" opacity-70 border-dashed")):s="bg-white border-gray-200 shadow-sm hover:bg-gray-50 hover:ring-2 hover:ring-gray-500/50",o.className=`file-item relative group border rounded-lg p-2 text-sm transition-all duration-200 ease-out transform-gpu hover:shadow-md hover:scale-[1.03] hover:z-20 hover:ring-2 cursor-pointer flex flex-col justify-between ${s}`,o.title=e.name,o.dataset.name=e.name,o.dataset.type=e.type,o.dataset.category=e.category||"",o.dataset.url=e.url||"",o.dataset.isEmpty=e.is_empty?"true":"false";const h=e.editable?`
            <button class="btn-edit absolute right-3 top-3 translate-x-12 group-hover:translate-x-0 transition-all duration-300 z-30 text-white border border-white hover:border-none hover:bg-blue-600 text-gray-800 hover:text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg" title="Sửa">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>
            </button>`:"",u=e.deletable?`
            <button class="btn-delete absolute right-3 top-12 translate-x-12 group-hover:translate-x-0 transition-all duration-300 z-30 text-white border border-white hover:border-none hover:bg-red-600 text-gray-800 hover:text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg" title="Xoá">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>`:"",c=e.category?`
            <div class="absolute top-2 left-2 text-white max-w-[80px] leading-tight font-medium z-20 bg-black/60 px-2 py-1 rounded-md break-words transition-all duration-300 translate-x-[-120%] group-hover:translate-x-0">
                ${e.category}
            </div>`:"",g='<div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10 rounded-lg"></div>';if(e.type==="folder"){const p=e.is_empty?`
                <div class="vmc-countdown-wrapper absolute top-1.5 left-1.5 z-20" title="Thư mục rỗng, sẽ tự động xóa sau 30 giây">
                    <svg width="28" height="28" viewBox="0 0 28 28" class="vmc-countdown-timer-svg">
                        <circle class="vmc-countdown-timer-bg" cx="14" cy="14" r="10"></circle>
                        <circle class="vmc-countdown-timer-fg" cx="14" cy="14" r="10"></circle>
                    </svg>
                </div>
            `:"";o.setAttribute("draggable","true"),o.innerHTML=`
                <div class="relative flex-grow w-full flex items-center justify-center rounded-md overflow-hidden h-28 bg-blue-100/50">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="70" viewBox="0 0 24 24" class="text-yellow-300 opacity-90"><path fill="currentColor" d="M4 20q-.825 0-1.412-.587T2 18V6q0-.825.588-1.412T4 4h6l2 2h8q.825 0 1.413.588T22 8v10q0 .825-.587 1.413T20 20z"/></svg>
                    ${g}
                    ${p}
                    ${c}
                    ${h}
                    ${u}
                </div>
                <div class="mt-2 text-center">
                    <div class="font-medium text-gray-800 truncate" title="${e.name}">${e.name}</div>
                    <div class="text-xs text-gray-500/70">&nbsp;</div>
                    <div class="mt-1 text-xs text-gray-500/70">&nbsp;</div>
                </div>
            `}else{o.setAttribute("draggable","true");let p;if(/\.(png|jpe?g|gif|webp|jfif)$/i.test(e.name))p=`<div class="image-placeholder w-full h-full bg-stone-200 dark:bg-zinc-700 animate-pulse flex items-center justify-center" data-src="${e.url||`/storage/uploads/${encodeURIComponent(e.name)}`}">
                    <svg class="animate-spin h-8 w-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>`;else{let m,d,i;switch(e.name.split(".").pop().toLowerCase()){case"pdf":m='<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M4 22h16a2 2 0 0 0 2-2V8l-6-6H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2Z"/><path d="M10.3 12.3a1 1 0 0 0-1.6 1.4l4 4a1 1 0 0 0 1.6-1.4l-4-4Z"/></svg>',d="bg-red-500",i="PDF";break;case"docx":case"doc":m='<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>',d="bg-blue-600",i="Word";break;case"xlsx":case"xls":m='<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m15 13-3 3 3 3"/><path d="m9 13 3 3-3 3"/></svg>',d="bg-green-600",i="Excel";break;case"pptx":case"ppt":m='<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 12h8"/><path d="M8 16h8"/><path d="M12 12v8"/></svg>',d="bg-orange-500",i="PowerPoint";break;case"zip":case"rar":case"7z":m='<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><line x1="10" y1="6" x2="10" y2="18" /><line x1="14" y1="6" x2="14" y2="18" /><path d="M17 6V4a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v2" /><path d="M17 18v2a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2v-2" /><path d="M21 12H3" /></svg>',d="bg-yellow-500",i="Archive";break;case"mp3":case"wav":case"ogg":m='<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>',d="bg-pink-500",i="Audio";break;case"mp4":case"mov":case"avi":case"mkv":m='<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="m22 8-6 4 6 4V8Z"/><rect x="2" y="6" width="14" height="12" rx="2"/></svg>',d="bg-indigo-500",i="Video";break;case"txt":case"xml":case"json":case"csv":case"svg":m='<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>',d="bg-slate-500",i="Text/Data";break;default:m='<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>',d="bg-gray-500",i="File"}p=`
                    <div class="w-full h-full flex flex-col items-center justify-center ${d} rounded-md">
                        ${m}
                        <span class="mt-2 text-xs font-bold text-white">${i}</span>
                    </div>
                `}const f=Te(e),N=f?`<div class="mt-1 text-xs text-gray-500" title="${f.toISOString()}">${Fe(f)}</div>`:'<div class="mt-1 text-xs text-gray-500">&nbsp;</div>';o.innerHTML=`
                <div class="relative overflow-hidden rounded-md h-28 bg-stone-100 dark:bg-zinc-800">
                    ${p}
                    ${g}
                    ${c}
                    ${h}
                    ${u}
                </div>
                <div class="mt-2 text-center">
                    <div class="font-medium text-gray-800 truncate" title="${e.name}">${e.name}</div>
                    <div class="text-xs text-gray-500">${e.size||"&nbsp;"}</div>
                    ${N}
                </div>
            `}r.appendChild(o)}),y.appendChild(r);const n=y.querySelectorAll(".image-placeholder[data-src]");n.length>0&&(console.log(`[FM-RENDER] renderFileGrid: Khởi tạo IntersectionObserver cho ${n.length} ảnh.`),K=new IntersectionObserver((e,o)=>{e.forEach(s=>Be(s,o))},{root:C,rootMargin:"50px",threshold:.01}),n.forEach(e=>K.observe(e))),console.log("[FM-RENDER] <== renderFileGrid: Hoàn tất render.")},De=(t,r)=>{if(D){if(console.log(`[FM-RENDER] renderPickedPreview: Hiển thị preview cho ${t.length} tệp chờ upload.`),D.innerHTML="",!t.length){z.textContent="Chưa chọn tệp";return}z.textContent=`${t.length} tệp đã chọn`,t.forEach((n,e)=>{const o=document.createElement("div");if(o.className="relative border rounded overflow-hidden",/^image\//.test(n.type)){const h=document.createElement("img");h.className="w-full h-24 object-cover",h.src=URL.createObjectURL(n),h.onload=()=>URL.revokeObjectURL(h.src),o.appendChild(h)}else o.innerHTML=`<div class="w-full h-24 flex items-center justify-center text-xs text-gray-600 p-2 text-center break-all">${n.name}</div>`;const s=document.createElement("button");s.className="absolute top-1 right-1 bg-red-600 text-white w-6 h-6 rounded-full text-sm flex items-center justify-center",s.textContent="×",s.title="Bỏ tệp này",s.onclick=()=>r(e),o.appendChild(s),D.appendChild(o)})}},He=t=>{const r=document.getElementById("breadcrumbNav");if(!r)return;console.log(`[FM-RENDER] renderBreadcrumbs: Render breadcrumbs cho path: "${t}"`),r.innerHTML="";let n="";const e=t.split("/").filter(s=>s),o=document.createElement("a");o.href="#",o.className="text-gray-600 hover:text-blue-800 no-underline transition-colors duration-200",o.textContent="Thư mục gốc",o.dataset.path="/",r.appendChild(o),e.forEach(s=>{n+=`/${s}`;const h=document.createElement("span");h.className="mx-2 text-gray-400",h.textContent="›",r.appendChild(h);const u=document.createElement("a");u.href="#",u.className="text-gray-600 hover:text-blue-800 no-underline transition-colors duration-200",u.textContent=s,u.dataset.path=n,r.appendChild(u)})},Pe=t=>{k&&(console.log(`[FM-RENDER] updateHeaderUI: Cập nhật nút "Quay về" cho path: "${t}"`),t!=="/"?(k.classList.remove("hidden"),k.classList.add("flex")):(k.classList.add("hidden"),k.classList.remove("flex")))};let oe="all",l="/",L=[],j=null,b=null,V=null,G={};const Oe=()=>{const t=Object.keys(G);t.length>0&&(console.log("[AUTO-DELETE] Hủy các lịch xóa thư mục rỗng trước đó."),t.forEach(r=>{clearTimeout(G[r]),delete G[r]}))},Ue=()=>{const t=y.querySelectorAll('.file-item[data-type="folder"][data-is-empty="true"]');t.length>0&&console.log(`[AUTO-DELETE] Tìm thấy ${t.length} thư mục rỗng. Bắt đầu đếm ngược 30 giây để xóa.`),t.forEach(r=>{const n=r.dataset.name;n&&(G[n]=setTimeout(async()=>{console.log(`[AUTO-DELETE] Hết thời gian, thực hiện xóa thư mục rỗng: ${n}`);try{await we({name:n,path:l}),v()}catch(e){console.error(`[AUTO-DELETE] Lỗi khi tự động xóa thư mục ${n}:`,e)}delete G[n]},3e4))})},v=async()=>{Oe(),console.log(`[FM-MAIN] ==> loadAndRenderFiles: Bắt đầu tải file cho path: "${l}", category: "${oe}"`),Ae();try{const t=await Ne(oe,(M==null?void 0:M.value)||"",l);console.log(`[FM-MAIN] loadAndRenderFiles: Tải thành công ${t.length} mục.`),Re(t),He(l),Pe(l),Ue()}catch(t){console.error("[FM-MAIN] Lỗi nghiêm trọng khi tải file:",t),Se("Không tải được danh sách tệp. Vui lòng kiểm tra Console (F12).")}console.log("[FM-MAIN] <== loadAndRenderFiles: Hoàn tất.")},se=t=>{L=L.concat(Array.from(t||[])),De(L,r=>{L.splice(r,1),se([])})},je=t=>{if(!t.url){alert("Tệp này không có đường dẫn để xem trước.");return}const{name:r,url:n}=t,e=r.split(".").pop().toLowerCase();if(fe.textContent=r,ye.href=n,A.innerHTML="",["png","jpg","jpeg","gif","webp","jfif","svg"].includes(e))A.innerHTML=`<img src="${n}" alt="${r}" class="max-w-full max-h-full object-contain">`;else if(["pdf","doc","docx","xls","xlsx","ppt","pptx","txt","xml","json","csv"].includes(e)){const o=new URL(n,window.location.origin).href,s=`https://docs.google.com/gview?url=${encodeURIComponent(o)}&embedded=true`;A.innerHTML=`<iframe src="${s}" class="w-full h-full border-0" title="Document Preview"></iframe>`}else{const o='<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 mb-4"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>';A.innerHTML=`
            <div class="flex flex-col items-center justify-center text-gray-600 h-full">
                ${o}
                <p class="font-semibold">Không thể xem trước tệp này.</p>
                <p class="text-sm">Vui lòng sử dụng nút "Tải xuống" để xem nội dung.</p>
            </div>
        `}ke()},ve=()=>{const t=le||T;if(!t||t.dataset.eventsAttached){console.log("[FM-MAIN] setupModalEventListeners: Bỏ qua vì container không tồn tại hoặc sự kiện đã được gán.");return}if(console.log("[FM-MAIN] ==> setupModalEventListeners: Bắt đầu gán các sự kiện cho các thành phần..."),q==null||q.addEventListener("click",ge),_==null||_.addEventListener("click",ge),$==null||$.addEventListener("click",n=>{const e=n.target.closest("a.category-link");e!=null&&e.dataset.category&&(n.preventDefault(),oe=e.dataset.category,$.querySelectorAll("a.category-link").forEach(o=>{o.classList.remove("bg-blue-600","text-white"),o.classList.add("text-gray-600","hover:bg-gray-200")}),e.classList.add("bg-blue-600","text-white"),e.classList.remove("text-gray-600","hover:bg-gray-200"),console.log(`[FM-MAIN] EVENT: Lọc theo danh mục: "${oe}"`),v())}),M==null||M.addEventListener("input",()=>{clearTimeout(M.timer),M.timer=setTimeout(()=>{console.log(`[FM-MAIN] EVENT: Tìm kiếm với từ khóa: "${M.value}"`),v()},300)}),te==null||te.addEventListener("click",async()=>{const n=prompt("Nhập tên thư mục mới:","Thư mục không tên");if(!n||n.trim()===""){console.log("[FM-MAIN] EVENT: Người dùng hủy tạo thư mục.");return}try{const e=await pe(n.trim(),l);e.success?(console.log(`[FM-MAIN] EVENT: Tạo thư mục "${n.trim()}" thành công.`),v()):alert(e.message||"Không thể tạo thư mục.")}catch(e){console.error("[FM-MAIN] EVENT: Lỗi khi tạo thư mục:",e),alert(`Lỗi: ${e.message}`)}}),Z==null||Z.addEventListener("click",()=>{L=[],console.log("[FM-MAIN] EVENT: Mở form upload."),me(),he()}),Y==null||Y.addEventListener("click",re),Q==null||Q.addEventListener("click",re),X==null||X.addEventListener("click",()=>B.click()),B==null||B.addEventListener("change",n=>se(n.target.files)),F==null||F.addEventListener("click",async()=>{var o;if(!L.length)return alert("Vui lòng chọn ít nhất 1 tệp.");const n=((o=document.querySelector('input[name="uploadCategory"]:checked'))==null?void 0:o.value)||"unclassified";console.log(`[FM-MAIN] EVENT: Submit form upload with ${L.length} tệp, category: ${n}, path: ${l}`);const e=new FormData;L.forEach(s=>e.append("files[]",s)),e.append("category",n),e.append("path",l),F.disabled=!0,F.textContent="Đang tải lên...";try{const s=await Ie(e);s!=null&&s.success?(re(),L=[],v()):alert((s==null?void 0:s.message)||"Không thể tải lên.")}catch(s){console.error("[FM-MAIN] Upload lỗi:",s),alert("Không thể tải lên. Kiểm tra Console.")}finally{F.disabled=!1,F.textContent="Tải lên"}}),y.addEventListener("click",async n=>{const e=n.target.closest(".file-item");if(!e)return;const o=e.dataset.name,s=e.dataset.type;if(s==="folder"&&!n.target.closest(".btn-edit, .btn-delete")){l=l==="/"?`/${o}`:`${l}/${o}`,console.log(`[FM-MAIN] EVENT: Điều hướng vào thư mục: "${l}"`),v();return}if(s==="file"&&!n.target.closest(".btn-edit, .btn-delete")){console.log(`[FM-MAIN] EVENT: Yêu cầu xem trước file: "${o}"`),je(e.dataset);return}if(n.target.closest(".btn-delete")){if(!o||!confirm(`Bạn có chắc muốn xoá:
${o} ?`))return;try{const c=await we({name:o,path:l});c.success?v():alert(c.message||"Không thể xoá.")}catch(c){alert(`Lỗi khi xóa: ${c.message}`)}}n.target.closest(".btn-edit")&&(j=o,be({name:o,category:e.dataset.category}))}),ee==null||ee.addEventListener("click",()=>{ue(),j=null}),ne==null||ne.addEventListener("click",()=>{$e()}),W==null||W.addEventListener("click",async()=>{const n=ie.value.trim(),e=ce.value;if(!n)return alert("Tên không được để trống.");if(!j)return alert("Lỗi: Không xác định được file cần sửa.");const o={name:j,path:l,new_name:n,category:e};try{const s=await U(o);s.success?(v(),ue(),j=null):alert(s.message||"Cập nhật thất bại.")}catch(s){alert(`Cập nhật thất bại: ${s.message}`)}}),C&&w){let n=0,e=null;const o=["ring-2","ring-blue-500","bg-white","z-20"],s=["ring-2","ring-purple-500","bg-white","z-20"],h=()=>{e&&(e.classList.remove(...o,...s),e=null)};y.addEventListener("dragstart",c=>{const g=c.target.closest('.file-item[draggable="true"]');g&&(V=g.dataset.type,b=g.dataset.name,c.dataTransfer.setData("text/plain",b),console.log(`[FM-MAIN] DRAG-START: Bắt đầu kéo item '${b}' (type: ${V})`),setTimeout(()=>g.classList.add("opacity-40"),0),l!=="/"&&(E==null||E.classList.remove("hidden")))}),y.addEventListener("dragend",c=>{const g=c.target.closest(".file-item");console.log("[FM-MAIN] DRAG-END: Kết thúc kéo item."),g&&g.classList.remove("opacity-40"),b=null,V=null,n>0&&(w.classList.add("hidden"),h(),n=0),E==null||E.classList.add("hidden")}),C.addEventListener("dragenter",c=>{c.preventDefault(),n++,n===1&&(w.classList.remove("hidden"),w.style.pointerEvents="auto")}),C.addEventListener("dragleave",c=>{c.preventDefault(),n--,n===0&&(w.style.pointerEvents="auto",w.classList.add("hidden"),h())}),C.addEventListener("dragover",c=>{c.preventDefault();const g=w.style.pointerEvents;w.style.pointerEvents="none";const p=document.elementFromPoint(c.clientX,c.clientY);w.style.pointerEvents=g||"auto";const a=p?p.closest(".file-item"):null;a&&a.dataset.type==="folder"&&a.dataset.name!==b?a!==e&&(h(),e=a,e.classList.add(...o)):V==="file"&&b&&a&&a.dataset.type==="file"&&a.dataset.name!==b?a!==e&&(h(),e=a,e.classList.add(...s)):h()}),C.addEventListener("drop",async c=>{var N;c.preventDefault(),w.classList.add("hidden"),w.style.pointerEvents="auto",n=0;const g=b,p=V,a=e,f=(N=c.dataTransfer)==null?void 0:N.files;if(console.log(`[FM-MAIN] DROP: Thả item. Dragged: '${g}', Target: '${a==null?void 0:a.dataset.name}', External files: ${(f==null?void 0:f.length)||0}`),h(),f&&f.length>1&&a&&a.dataset.type==="file"){const m=a.dataset.name;console.log(`[MERGE] Yêu cầu gộp ${f.length} file từ bên ngoài vào file '${m}'.`);const d=new FormData;Array.from(f).forEach(i=>{d.append("files[]",i)}),d.append("target_file",m),d.append("path",l),console.log("[MERGE-DEBUG] Chuẩn bị gửi FormData. Dữ liệu:");for(let[i,I]of d.entries())I instanceof File?console.log(`  - ${i}: [File] name="${I.name}", type="${I.type}"`):console.log(`  - ${i}: ${I}`);try{const i=await Ce(d);if(i.success)console.log("[MERGE] Gộp file thành công."),v();else throw new Error(i.message||"Không thể gộp các tệp.")}catch(i){console.error("Lỗi khi gộp nhiều file từ bên ngoài:",i),alert(`Lỗi khi gộp file: ${i.message}`)}return}if(p==="file"&&g&&a&&a.dataset.type==="file"){const m=a.dataset.name,d=new Date,i=String(d.getDate()).padStart(2,"0"),I=String(d.getMonth()+1).padStart(2,"0"),xe=d.getFullYear(),Ee=`${d.getHours()}${d.getMinutes()}${d.getSeconds()}`,J=`Gộp ${i}-${I}-${xe} ${Ee}`,de=l==="/"?`/${J}`:`${l}/${J}`;try{console.log(`[MERGE] Bắt đầu gộp '${g}' và '${m}' vào folder mới: '${J}'`);const O=await pe(J,l);if(!O.success)throw new Error(O.message||"Không thể tạo thư mục.");await U({name:g,path:l,parent:de}),await U({name:m,path:l,parent:de}),console.log("[MERGE] Gộp file hoàn tất."),v()}catch(O){console.error("Lỗi khi gộp file:",O),alert(`Lỗi khi gộp file: ${O.message}`)}return}if(g&&a&&a.dataset.type==="folder"&&g!==a.dataset.name){const m=a.dataset.name,d=l==="/"?`/${m}`:`${l}/${m}`;try{const i=await U({name:g,path:l,parent:d});i.success?v():alert(i.message||"Không thể di chuyển tệp.")}catch(i){console.error("Lỗi khi di chuyển tệp:",i),alert(`Lỗi khi di chuyển tệp: ${i.message}`)}return}if(f&&f.length>0){a&&a.dataset.type==="folder"&&a.dataset.name,L=[],me(),he(),se(f),console.log("[DROP] Không khớp kịch bản nào → bỏ qua.");return}});const u=$==null?void 0:$.parentElement;u==null||u.addEventListener("dragover",c=>{c.preventDefault()}),u==null||u.addEventListener("drop",async c=>{c.preventDefault(),E==null||E.classList.add("hidden");const g=b;if(!(!g||l==="/"))try{const p=l.split("/").filter(m=>m);p.pop();const a="/"+p.join("/"),N=await U({name:g,path:l,parent:a});N.success?v():alert(N.message||"Không thể di chuyển tệp.")}catch(p){console.error("Lỗi khi di chuyển tệp lên thư mục cha:",p),alert(`Lỗi khi di chuyển tệp: ${p.message}`)}})}k==null||k.addEventListener("click",()=>{if(l==="/")return;const n=l.split("/").filter(e=>e);n.pop(),l="/"+n.join("/"),console.log(`[FM-MAIN] EVENT: Quay về thư mục: "${l}"`),v()});const r=document.getElementById("breadcrumbNav");r==null||r.addEventListener("click",n=>{n.preventDefault();const e=n.target.closest("a[data-path]");e&&(l=e.dataset.path,console.log(`[FM-MAIN] EVENT: Điều hướng bằng breadcrumb tới: "${l}"`),v())}),t.dataset.eventsAttached="true",console.log("[FM-MAIN] <== setupModalEventListeners: Gán sự kiện hoàn tất.")};document.addEventListener("DOMContentLoaded",()=>{console.log("[FM-MAIN] DOMContentLoaded: Trang đã tải xong."),Me(),le?(console.log("[FM-MAIN] INIT: Giao diện File Manager được nhúng trực tiếp. Bắt đầu khởi chạy..."),ve(),v()):(console.log("[FM-MAIN] INIT: Giao diện nhúng không tìm thấy. Lắng nghe sự kiện mở modal."),document.body.addEventListener("click",t=>{t.target.closest('[data-action="open-file-manager"]')&&(console.log("[FM-MAIN] EVENT: Nút trigger được nhấn. Mở modal file manager."),t.preventDefault(),Le(),ve(),v())}))});
